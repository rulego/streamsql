# StreamSQL

[English](README.md)| ç®€ä½“ä¸­æ–‡

**StreamSQL** æ˜¯ä¸€æ¬¾è½»é‡çº§çš„ã€åŸºäº SQL çš„ç‰©è”ç½‘è¾¹ç¼˜æµå¤„ç†å¼•æ“ã€‚å®ƒèƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å’Œåˆ†ææ— ç•Œæ•°æ®æµã€‚

ç±»ä¼¼: [Apache Flink](https://flink.apache.org/) å’Œ [ekuiper](https://ekuiper.org/)

## åŠŸèƒ½ç‰¹æ€§

- è½»é‡çº§
  - çº¯å†…å­˜æ“ä½œ
  - æ— ä¾èµ–
- SQLè¯­æ³•å¤„ç†æ•°æ®
- æ•°æ®åˆ†æ
  - å†…ç½®å¤šç§çª—å£ç±»å‹ï¼šæ»‘åŠ¨çª—å£ã€æ»šåŠ¨çª—å£ã€è®¡æ•°çª—å£
  - å†…ç½®èšåˆå‡½æ•°ï¼šMAX, MIN, AVG, SUM, STDDEV,MEDIAN,PERCENTILEç­‰
  - æ”¯æŒåˆ†ç»„èšåˆ
  - æ”¯æŒè¿‡æ»¤æ¡ä»¶
- é«˜å¯æ‰©å±•æ€§
  - æä¾›çµæ´»çš„å‡½æ•°æ‰©å±•
  - **å®Œæ•´çš„è‡ªå®šä¹‰å‡½æ•°ç³»ç»Ÿ**ï¼šæ”¯æŒæ•°å­¦ã€å­—ç¬¦ä¸²ã€è½¬æ¢ã€èšåˆã€åˆ†æç­‰8ç§å‡½æ•°ç±»å‹
  - **ç®€å•æ˜“ç”¨çš„å‡½æ•°æ³¨å†Œ**ï¼šä¸€è¡Œä»£ç å³å¯æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°
  - **è¿è¡Œæ—¶åŠ¨æ€æ‰©å±•**ï¼šæ”¯æŒåœ¨è¿è¡Œæ—¶æ·»åŠ ã€ç§»é™¤å’Œç®¡ç†å‡½æ•°
  - æ¥å…¥`RuleGo`ç”Ÿæ€ï¼Œåˆ©ç”¨`RuleGo`ç»„ä»¶æ–¹å¼æ‰©å±•è¾“å‡ºå’Œè¾“å…¥æº
- ä¸[RuleGo](https://gitee.com/rulego/rulego) é›†æˆ
  - åˆ©ç”¨`RuleGo`ä¸°å¯Œçµæ´»çš„è¾“å…¥ã€è¾“å‡ºã€å¤„ç†ç­‰ç»„ä»¶ï¼Œå®ç°æ•°æ®æºæ¥å…¥ä»¥åŠå’Œç¬¬ä¸‰æ–¹ç³»ç»Ÿè”åŠ¨

## å®‰è£…

```bash
go get github.com/rulego/streamsql
```

## ä½¿ç”¨

```go
package main

import (
	"context"
	"fmt"
	"testing"
	"time"

	"math/rand"
	"github.com/rulego/streamsql"
)

func main() {
	ssql := streamsql.New()
	// å®šä¹‰SQLè¯­å¥ã€‚å«ä¹‰ï¼šæ¯éš”5ç§’æŒ‰deviceIdåˆ†ç»„è¾“å‡ºè®¾å¤‡çš„æ¸©åº¦å¹³å‡å€¼å’Œæ¹¿åº¦æœ€å°å€¼ã€‚
	rsql := "SELECT deviceId,avg(temperature) as avg_temp,min(humidity) as min_humidity ," +
		"window_start() as start,window_end() as end FROM  stream  where deviceId!='device3' group by deviceId,TumblingWindow('5s')"
	// æ ¹æ®SQLè¯­å¥ï¼Œåˆ›å»ºæµå¼åˆ†æä»»åŠ¡ã€‚
	err := ssql.Execute(rsql)
	if err != nil {
		panic(err)
	}
	var wg sync.WaitGroup
	wg.Add(1)
	// è®¾ç½®30ç§’æµ‹è¯•è¶…æ—¶æ—¶é—´
	ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
	defer cancel()
	// æ·»åŠ æµ‹è¯•æ•°æ®
	go func() {
		defer wg.Done()
		ticker := time.NewTicker(1 * time.Second)
		defer ticker.Stop()
		for {
			select {
			case <-ticker.C:
				// ç”Ÿæˆéšæœºæµ‹è¯•æ•°æ®ï¼Œæ¯ç§’ç”Ÿæˆ10æ¡æ•°æ®
				for i := 0; i < 10; i++ {
					randomData := map[string]interface{}{
						"deviceId":    fmt.Sprintf("device%d", rand.Intn(2)+1),
						"temperature": 20.0 + rand.Float64()*10, // 20-30åº¦ä¹‹é—´
						"humidity":    50.0 + rand.Float64()*20, // 50-70%æ¹¿åº¦
					}
					// å°†æ•°æ®æ·»åŠ åˆ°æµä¸­
					ssql.stream.AddData(randomData)
				}

			case <-ctx.Done():
				return
			}
		}
	}()

	resultChan := make(chan interface{})
	// æ·»åŠ è®¡ç®—ç»“æœå›è°ƒ
	ssql.stream.AddSink(func(result interface{}) {
		resultChan <- result
	})
	// è®°å½•æ”¶åˆ°çš„ç»“æœæ•°é‡
	resultCount := 0
	go func() {
		for result := range resultChan {
			//æ¯éš”5ç§’æ‰“å°ä¸€æ¬¡ç»“æœ
			fmt.Printf("æ‰“å°ç»“æœ: [%s] %v\n", time.Now().Format("15:04:05.000"), result)
			resultCount++
		}
	}()
    //æµ‹è¯•ç»“æŸ
	wg.Wait()
}
```

## å‡½æ•°

StreamSQL æ”¯æŒå¤šç§å‡½æ•°ç±»å‹ï¼ŒåŒ…æ‹¬æ•°å­¦ã€å­—ç¬¦ä¸²ã€è½¬æ¢ã€èšåˆã€åˆ†æã€çª—å£ç­‰ä¸Šç™¾ä¸ªå‡½æ•°ã€‚[æ–‡æ¡£](docs/FUNCTIONS_USAGE_GUIDE.md)

### ğŸ¨ æ”¯æŒçš„å‡½æ•°ç±»å‹

- **ğŸ“Š æ•°å­¦å‡½æ•°** - sqrt, power, abs, ä¸‰è§’å‡½æ•°ç­‰
- **ğŸ“ å­—ç¬¦ä¸²å‡½æ•°** - concat, upper, lower, trimç­‰  
- **ğŸ”„ è½¬æ¢å‡½æ•°** - cast, hex2dec, encode/decodeç­‰
- **ğŸ“ˆ èšåˆå‡½æ•°** - è‡ªå®šä¹‰èšåˆé€»è¾‘
- **ğŸ” åˆ†æå‡½æ•°** - lag, latest, å˜åŒ–æ£€æµ‹ç­‰

## æ¦‚å¿µ

### çª—å£

ç”±äºæµæ•°æ®æ˜¯æ— é™çš„ï¼Œå› æ­¤ä¸å¯èƒ½å°†å…¶ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥å¤„ç†ã€‚çª—å£æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå°†æ— ç•Œçš„æ•°æ®åˆ†å‰²æˆä¸€ç³»åˆ—è¿ç»­çš„æœ‰ç•Œæ•°æ®æ¥è®¡ç®—ã€‚StreamSQL å†…ç½®ä»¥ä¸‹çª—å£ç±»å‹ï¼š

- **æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰**
  - **å®šä¹‰**ï¼šåŸºäºæ—¶é—´çš„çª—å£ï¼Œçª—å£ä»¥å›ºå®šçš„æ—¶é—´é—´éš”å‘å‰æ»‘åŠ¨ã€‚ä¾‹å¦‚ï¼Œæ¯ 10 ç§’æ»‘åŠ¨ä¸€æ¬¡ã€‚
  - **ç‰¹ç‚¹**ï¼šçª—å£çš„å¤§å°å›ºå®šï¼Œä½†çª—å£çš„èµ·å§‹ç‚¹ä¼šéšç€æ—¶é—´æ¨ç§»è€Œä¸æ–­æ›´æ–°ã€‚é€‚åˆå¯¹è¿ç»­æ—¶é—´æ®µå†…çš„æ•°æ®è¿›è¡Œå®æ—¶ç»Ÿè®¡åˆ†æã€‚
  - **åº”ç”¨åœºæ™¯**ï¼šåœ¨æ™ºèƒ½äº¤é€šç³»ç»Ÿä¸­ï¼Œæ¯ 10 ç§’ç»Ÿè®¡ä¸€æ¬¡è¿‡å» 1 åˆ†é’Ÿå†…çš„è½¦è¾†æµé‡ã€‚

- **æ»šåŠ¨çª—å£ï¼ˆTumbling Windowï¼‰**
  - **å®šä¹‰**ï¼šåŸºäºæ—¶é—´çš„çª—å£ï¼Œçª—å£ä¹‹é—´æ²¡æœ‰é‡å ï¼Œå®Œå…¨ç‹¬ç«‹ã€‚ä¾‹å¦‚ï¼Œæ¯ 1 åˆ†é’Ÿç”Ÿæˆä¸€ä¸ªçª—å£ã€‚
  - **ç‰¹ç‚¹**ï¼šçª—å£çš„å¤§å°å›ºå®šï¼Œä¸”çª—å£ä¹‹é—´äº’ä¸é‡å ï¼Œé€‚åˆå¯¹å›ºå®šæ—¶é—´æ®µå†…çš„æ•°æ®è¿›è¡Œæ•´ä½“åˆ†æã€‚
  - **åº”ç”¨åœºæ™¯**ï¼šåœ¨æ™ºèƒ½å†œä¸šç›‘æ§ç³»ç»Ÿä¸­ï¼Œæ¯å°æ—¶ç»Ÿè®¡ä¸€æ¬¡è¯¥å°æ—¶å†…å†œç”°çš„æ¸©åº¦å’Œæ¹¿åº¦ã€‚

- **è®¡æ•°çª—å£ï¼ˆCount Windowï¼‰**
  - **å®šä¹‰**ï¼šåŸºäºæ•°æ®æ¡æ•°çš„çª—å£ï¼Œçª—å£å¤§å°ç”±æ•°æ®æ¡æ•°å†³å®šã€‚ä¾‹å¦‚ï¼Œæ¯ 100 æ¡æ•°æ®ç”Ÿæˆä¸€ä¸ªçª—å£ã€‚
  - **ç‰¹ç‚¹**ï¼šçª—å£çš„å¤§å°ä¸æ—¶é—´æ— å…³ï¼Œè€Œæ˜¯æ ¹æ®æ•°æ®é‡æ¥åˆ’åˆ†ï¼Œé€‚åˆå¯¹æ•°æ®é‡è¿›è¡Œåˆ†æ®µå¤„ç†ã€‚
  - **åº”ç”¨åœºæ™¯**ï¼šåœ¨å·¥ä¸šç‰©è”ç½‘ä¸­ï¼Œæ¯å¤„ç† 100 æ¡è®¾å¤‡çŠ¶æ€æ•°æ®åè¿›è¡Œä¸€æ¬¡èšåˆè®¡ç®—ã€‚

### æµï¼ˆStreamï¼‰

- **å®šä¹‰**ï¼šæµæ˜¯æ•°æ®çš„è¿ç»­åºåˆ—ï¼Œæ•°æ®ä»¥æ— ç•Œçš„æ–¹å¼äº§ç”Ÿï¼Œé€šå¸¸æ¥è‡ªäºä¼ æ„Ÿå™¨ã€æ—¥å¿—ç³»ç»Ÿã€ç”¨æˆ·è¡Œä¸ºç­‰ã€‚
- **ç‰¹ç‚¹**ï¼šæµæ•°æ®å…·æœ‰å®æ—¶æ€§ã€åŠ¨æ€æ€§å’Œæ— é™æ€§ï¼Œéœ€è¦åŠæ—¶å¤„ç†å’Œåˆ†æã€‚
- **åº”ç”¨åœºæ™¯**ï¼šç‰©è”ç½‘è®¾å¤‡äº§ç”Ÿçš„å®æ—¶æ•°æ®æµï¼Œå¦‚æ¸©åº¦ä¼ æ„Ÿå™¨æ•°æ®ã€è®¾å¤‡çŠ¶æ€æ•°æ®ç­‰ã€‚

### æ—¶é—´è¯­ä¹‰

- **äº‹ä»¶æ—¶é—´ï¼ˆEvent Timeï¼‰**
  - **å®šä¹‰**ï¼šæ•°æ®å®é™…å‘ç”Ÿçš„æ—¶é—´ï¼Œé€šå¸¸ç”±æ•°æ®æºç”Ÿæˆçš„æ—¶é—´æˆ³è¡¨ç¤ºã€‚

- **å¤„ç†æ—¶é—´ï¼ˆProcessing Timeï¼‰**
  - **å®šä¹‰**ï¼šæ•°æ®åˆ°è¾¾å¤„ç†ç³»ç»Ÿçš„æ—¶é—´ã€‚
- **çª—å£å¼€å§‹æ—¶é—´ï¼ˆWindow Start Timeï¼‰**
  - **å®šä¹‰**ï¼šåŸºäºäº‹ä»¶æ—¶é—´ï¼Œçª—å£çš„èµ·å§‹æ—¶é—´ç‚¹ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªåŸºäºäº‹ä»¶æ—¶é—´çš„æ»‘åŠ¨çª—å£ï¼Œçª—å£å¼€å§‹æ—¶é—´æ˜¯çª—å£å†…æœ€æ—©äº‹ä»¶çš„æ—¶é—´æˆ³ã€‚
- **çª—å£ç»“æŸæ—¶é—´ï¼ˆWindow End Timeï¼‰**
  - **å®šä¹‰**ï¼šåŸºäºäº‹ä»¶æ—¶é—´ï¼Œçª—å£çš„ç»“æŸæ—¶é—´ç‚¹ã€‚é€šå¸¸çª—å£ç»“æŸæ—¶é—´æ˜¯çª—å£å¼€å§‹æ—¶é—´åŠ ä¸Šçª—å£çš„æŒç»­æ—¶é—´ã€‚
  - ä¾‹å¦‚ï¼Œä¸€ä¸ªæ»‘åŠ¨çª—å£çš„æŒç»­æ—¶é—´ä¸º 1 åˆ†é’Ÿï¼Œåˆ™çª—å£ç»“æŸæ—¶é—´æ˜¯çª—å£å¼€å§‹æ—¶é—´åŠ ä¸Š 1 åˆ†é’Ÿã€‚

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤PRå’ŒIssueã€‚è¯·ç¡®ä¿ä»£ç ç¬¦åˆGoæ ‡å‡†ï¼Œå¹¶æ·»åŠ ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹ã€‚

## è®¸å¯è¯

Apache License 2.0